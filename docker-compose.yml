version: "3.9"

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-appdb}
    command: ["postgres","-c","wal_level=logical","-c","max_replication_slots=4","-c","max_wal_senders=4"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/postgres-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-appdb}"]
      interval: 5s
      timeout: 5s
      retries: 5

  #app:
  #  build: .
  #  depends_on:
  #    db:
  #      condition: service_healthy
  #  env_file:
  #    - .env
  #  environment:
  #    - DATABASE_URL
  #    - PORT
  #    - MIGRATE_ON_START
  #  ports:
  #    - "${PORT:-8080}:8080"
  #  restart: on-failure

  adminer:
    image: adminer:latest
    ports:
      - "${ADMINER_PORT:-8081}:8080"
    restart: unless-stopped
    depends_on:
      - db

  zookeeper:
    image: bitnami/zookeeper:latest
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"
    restart: unless-stopped

  kafka:
    image: bitnami/kafka:latest
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    restart: unless-stopped

  connect:
    image: debezium/connect:2
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=connect-configs
      - OFFSET_STORAGE_TOPIC=connect-offsets
      - STATUS_STORAGE_TOPIC=connect-status
      - KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - KEY_CONVERTER_SCHEMAS_ENABLE=false
      - VALUE_CONVERTER_SCHEMAS_ENABLE=false
    ports:
      - "8083:8083"
    depends_on:
      - kafka
    restart: unless-stopped

  connect-init:
    image: curlimages/curl:latest
    volumes:
      - ./docker/debezium:/docker/debezium:ro
    entrypoint: ["/docker/debezium/register-connector.sh"]
    depends_on:
      - connect
    restart: "no"

volumes:
  pgdata:
